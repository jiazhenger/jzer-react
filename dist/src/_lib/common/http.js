import n from"../../../node_modules/@babel/runtime/helpers/esm/toConsumableArray.js";import o from"../../../node_modules/@babel/runtime/helpers/esm/defineProperty.js";import l from"axios";import e from"../../config.js";import a from"./fn.js";function t(n,o){var l=Object.keys(n);if(Object.getOwnPropertySymbols){var e=Object.getOwnPropertySymbols(n);o&&(e=e.filter((function(o){return Object.getOwnPropertyDescriptor(n,o).enumerable}))),l.push.apply(l,e)}return l}function r(n){for(var l=1;l<arguments.length;l++){var e=null!=arguments[l]?arguments[l]:{};l%2?t(Object(e),!0).forEach((function(l){o(n,l,e[l])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):t(Object(e)).forEach((function(o){Object.defineProperty(n,o,Object.getOwnPropertyDescriptor(e,o))}))}return n}var i=e.isOnLyPostGet,u=e.env,d=e.contentType,s=function(n,o,l,e,a){if(u){var t=["red","green","orange"];console.log("%c ==================================【 ".concat(n," 】【 ").concat(o," 】=================================="),"color:"+t[a]),console.log(" 参数：",l||{}),console.log(" 数据：",e),console.log("%c ————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————— end ","color:"+t[a])}},c=[],g=function(n,o){if(!a.hasObject(n))return"";var l=n,e="";for(var t in l){var r=l[t];o?e+=t+"="+(void 0===r?"":r)+"&":a.isNotEmpty(r)&&(e+=t+"="+r+"&")}return"&"===e.charAt(e.length-1)&&(e=e.slice(0,e.length-1)),e=e?"?"+e:encodeURI(e)},p=function(n,o){if(a.isFunction(n))n=n();else if(a.hasObject(n))for(var l in n){var e=n[l];a.isEmpty(e)&&(!0===o?n[l]="":null===o?n[l]=null:delete n[l])}return n},v=function(n,o){if(n)if(a.isFunction(n))n((function(n){for(var l in o)n[l]=o[l];return r({},n)}));else if(null!=n&&n.setState)n.stateState(o);else for(var l in o)n[l]=o[l]},m=function(n,o,t,i){var u,v=i||{};if(!a.isString(n)||!a.isNotEmpty(n))return Promise.reject(),a.toast("接口未传递正确");var m="get"!==t;void 0!==v.empty&&(m=v.empty);var f=function(n){var o=n.type,e=n.token,t=n.api;n.upload;var i=n.download,u={"Content-Type":["application/json;charset=utf-8","application/x-www-form-urlencoded","multipart/form-data"][a.isNotEmpty(o)?o:d]},s=a.getToken()?{Authorization:a.getToken()}:{};return{baseURL:t,headers:!1===e?u:r(r({},u),s),timeout:3e4,responseType:i?"blob":null,cancelToken:new(0,l.CancelToken)((function(n){c.push(n)}))}}(r({api:-1!==n.indexOf("http")?n:e.api()},v));null==v||null===(u=v.onStart)||void 0===u||u.call(v),n=a.isNotEmpty(v.id)?n+"/"+v.id:n;var y={get:function(){return l.get(n+g(o,m),f)},delete:function(){return l.delete(n+g(o,m),f)},post:function(){return l.post(n,p(o,m),f)},put:function(){return l.put(n,p(o,m),f)},patch:function(){return l.patch(n,p(o,m),f)}}[t]();return new Promise((function(r,i){y.then((function(l){var u,d,c=l.data,g=c.code,p=c.data,m=c.msg;if(200===g)r(p),s(t,n,o,p,1);else if(g===e.noLoginCode||g===e.loginExpireCode){var f,y,h,N,E,w,b,P,S,j,O,T,x,L,R,k,M;a.toast(g===e.noLoginCode?"请先登录":"登录信息已过期，请重新登录!"),a.localRemove("user"),a.recordSkip(),s(t,n,o,p,2),a.login?null===(f=a.login)||void 0===f||f.call(a):setTimeout((function(){return a.go("/login")}),200),v.pass&&r(null),null===(y=window)||void 0===y||null===(h=y.$modalRef)||void 0===h||null===(N=h.call(y))||void 0===N||null===(E=N.close)||void 0===E||E.call(N),null===(w=window)||void 0===w||null===(b=w.$formModalRef)||void 0===b||null===(P=b.call(w))||void 0===P||null===(S=P.close)||void 0===S||S.call(P),null===(j=window)||void 0===j||null===(O=j.$tableModalRef)||void 0===O||null===(T=O.call(j))||void 0===T||null===(x=T.close)||void 0===x||x.call(T),null===(L=window)||void 0===L||null===(R=L.$imageModalRef)||void 0===R||null===(k=R.call(L))||void 0===k||null===(M=k.close)||void 0===M||M.call(k)}else{var A,F,z;if(v.download)return a.loading(!1),r(c),void s(t,n,o,p,1);if(i(p),v.onMsg)null==v||null===(F=v.onMsg)||void 0===F||F.call(v,p),null==v||null===(z=v.onError)||void 0===z||z.call(v,p);else a.toast(m,v.onError,3e4);null==v||null===(A=v.onFail)||void 0===A||A.call(v,c),s(t,n,o,p,2),v.pass&&r(null)}null==v||null===(u=v.onEnd)||void 0===u||u.call(v,c),null==v||null===(d=v.onSuccess)||void 0===d||d.call(v,c)}),(function(e){var i,u,d;if(l.isCancel(e))return s(t,n+" 接口请求被取消",o,"无",0);v.noError||a.toast("服务器或网络出错"),null==v||null===(i=v.onNet)||void 0===i||i.call(v),null==v||null===(u=v.onError)||void 0===u||u.call(v),null==v||null===(d=v.onEnd)||void 0===d||d.call(v),s(t,n,o,"无",0),v.pass&&r(null)}))}))},f=function(n,l,e){var t,i=r({param:{},loading:!0,loadingName:"postLoading",method:"post",type:d},e);if(!l)return Promise.reject(),a.toast("接口未传递正确");if(v(n,(o(t={},i.loadingName,!0),o(t,"loading",!0),t)),i.loading){var u=i.loadingText||"数据提交中";a.loading(!0,u+"...")}var s=function(){i.onSuccess&&i.onSuccess()};return new Promise((function(e,t){var u=a.isFunction(i.param)?i.param():i.param;m(l,2===i.type?u:r(r({},null==n?void 0:n.model),u),i.method,{onStart:function(){var n;return null==i||null===(n=i.onStart)||void 0===n?void 0:n.call(i)},onEnd:function(){var l,e;v(n,(o(l={},i.loadingName,!1),o(l,"loading",!1),l)),i.loading&&a.loading(!1),null==i||null===(e=i.onEnd)||void 0===e||e.call(i)},onMsg:i.onMsg&&function(n){var o;return null==i||null===(o=i.onMsg)||void 0===o?void 0:o.call(i,n)},noError:i.noError,onError:i.onError,onFail:i.onFail,token:i.token,type:i.type,id:i.id,empty:i.empty}).then((function(n){e(n),i.successText?i.runFirst?(a.toast(i.successText),s()):a.toast(i.successText,s):s()}),(function(n){t(n)}))}))},y=function(n,l,e){var t=r({param:{},dataName:"data",loading:!1,loadingName:"pullLoading"},e);if(!l)return Promise.reject(),a.toast("接口未传递正确");if(n){var i,u,d,s;if(t.first&&!n.first)v(n,(o(d={},t.loadingName,!0),o(d,"loading",!0),o(d,"first",!0),d));else v(n,(o(s={},t.loadingName,!0),o(s,"loading",!0),s));null==t||null===(i=t.onLoading)||void 0===i||i.call(t,!0),null==n||null===(u=n.onLoading)||void 0===u||u.call(n,n.loading)}if(t.loading){var c=t.loadingText||"数据加载中";a.loading(!0,c+"...")}return new Promise((function(e,i){var u=a.isFunction(t.param)?t.param():t.param;t.setParam&&(u=r(r({},u),t.setParam(u))),m(l,u,"get",{id:t.id,onStart:function(){var n;return null==t||null===(n=t.onStart)||void 0===n?void 0:n.call(t)},onEnd:function(){var l,e,r,i;v(n,(o(l={},t.loadingName,!1),o(l,"loading",!1),l)),t.loading&&a.loading(!1),null===(e=t.onEnd)||void 0===e||e.call(t),null==n||null===(r=n.onLoading)||void 0===r||r.call(n,n.loading),null==t||null===(i=t.onLoading)||void 0===i||i.call(t,!1)},onMsg:t.onMsg&&function(n){var o;return null==t||null===(o=t.onMsg)||void 0===o?void 0:o.call(t,n)},noError:t.noError,onError:function(){var n;null==t||null===(n=t.onError)||void 0===n||n.call(t),t.loading&&a.loading(!1)},token:t.token,download:t.download,pass:t.pass,empty:t.empty}).then((function(l){var i=null!=l&&l.rows?l.rows:l;a.isFunction(t.onSuccess)&&(i=t.onSuccess(i)),t.paging?e(l):(t.setName&&(i=a.hasArray(i)?i.map((function(n,o){return r(r({},n),t.setName(n,o))})):r(r({},i),t.setName(i))),v(n,o({},t.dataName,i)),e(i))}))}))},h={post:f,del:function(n,o,l){return f(n,o,r({method:i?"post":"delete",loadingText:"数据删除中"},l))},put:function(n,o,l){return f(n,o,r({method:i?"post":"put",loadingText:"数据修改中"},l))},upload:function(n,o,l){var e;return f(n,o,r({method:null!==(e=l.way)&&void 0!==e?e:"post",loadingText:"数据上传中",type:2},l))},download:function(n,o,l){return y(n,o,r({loadingText:"数据下载中",loading:!0,download:!0},l))},pull:y,paging:function(l,t,i){var u=r({param:{},loading:!1,loadingName:"pagingLoading",dataName:"data",paging:!0},i);if(!t)return Promise.reject(),a.toast("接口未传递正确");var d=(null==e?void 0:e.paging)||{},s=d.dataName,c=void 0===s?"data":s,g=d.pageSizeName,p=void 0===g?"size":g,m=d.pageNumName,f=void 0===m?"page":m,h=d.totalItemsName,N=void 0===h?"total_items":h,E=d.totalPagesName,w=void 0===E?"total_pages":E,b=d.pageSize,P=void 0===b?10:b,S=a.getResult(u.param),j=a.getResult(u.query),O=a.getResult(u.arg),T=S;if(u.resetEmpty&&(u.resetSearch=!0),l){var x=a.getResult(l.model),L=a.getResult(l.query);l.model=u.resetSearch?{}:r(r({},x),S),l.query=u.resetSearch?{}:r(r({},L),j),T=null==l?void 0:l.model}var R,k,M,A,F=T;if(u.resetEmpty)return u.loading&&a.loading(!1),null==l||null===(R=l.onLoading)||void 0===R||R.call(l,l.loading),v(l,(o(k={},u.dataName,[]),o(k,u.loadingName,!1),o(k,"loading",!1),k)),null===(M=u.onEnd)||void 0===M||M.call(u),null==u||null===(A=u.onLoading)||void 0===A||A.call(u,!1),Promise.resolve({data:[]});if(0!==u.paging&&!1!==u.paging){var z,C=null!==(z=F)&&void 0!==z?z:{},q=C.page,D=C.size;F=r(r(r({page:q||1,size:D||P},null==l?void 0:l.query),T),O)}else F=r(r(r({},null==l?void 0:l.query),O),T);return new Promise((function(e){y(l,t,{onStart:function(){var n;null==u||null===(n=u.onStart)||void 0===n||n.call(u)},onEnd:function(){var n;null==u||null===(n=u.onEnd)||void 0===n||n.call(u)},onError:function(){var n;null==u||null===(n=u.onError)||void 0===n||n.call(u),v(l,o({},u.dataName,[]))},loading:u.loading,loadingName:u.loadingName,setParam:u.setParam,paging:!0,empty:!0,param:F,id:u.id}).then((function(t){if(0!==u.paging&&!1!==u.paging){var i=(null==t?void 0:t[c])||(null==t?void 0:t.rows);Array.isArray(i)||(i=[]),u.setName&&(i=i.map((function(n,o){return r(r({},n),u.setName(n,o))})));var d=+t[f],s=+t[p],g=+t[w],m={page:d,size:s,total:+t[N],pages:g,data:i,result:t,param:F};v(l,o({pager:m},u.dataName,a.hasArray(i)?n(i):[])),e({data:i,pager:m,result:t})}else{var y=Array.isArray(t)?t:(null==t?void 0:t[c])||(null==t?void 0:t.rows)||[];u.setName&&(y=y.map((function(n,o){return r(r({},n),u.setName(n,o))}))),v(l,o({},u.dataName,y)),e({data:t})}}))}))},patch:function(n,o,l){return f(n,o,r({method:i?"post":"patch",loadingText:"数据修改中"},l))},stop:function(){c.forEach((function(n){return n()})),c=[]},serializeParam:g};export{h as default};
